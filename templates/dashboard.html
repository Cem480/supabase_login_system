{% extends "base.html" %}

{% block title %}Dashboard - Supabase Auth{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Welcome Header -->
    <div class="dashboard-header">
        <div class="user-welcome">
            <div class="user-avatar">
                {% if user.avatar_url %}
                    <img src="{{ user.avatar_url }}" alt="{{ user.full_name or user.email }}">
                {% else %}
                    <i class="fas fa-user-circle"></i>
                {% endif %}
            </div>
            <div class="user-info">
                <h1>Welcome back{% if user.full_name %}, {{ user.full_name }}{% endif %}!</h1>
                <p class="user-email">{{ user.email }}</p>
            </div>
        </div>
        <div class="header-actions">
            <button onclick="logoutAll()" class="btn btn-outline">
                <i class="fas fa-sign-out-alt"></i>
                Logout from all devices
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon bg-primary">
                <i class="fas fa-user-check"></i>
            </div>
            <div class="stat-content">
                <h3>Account Status</h3>
                <p class="stat-value">
                    {% if user.email_verified %}
                        <span class="badge badge-success">Verified</span>
                    {% else %}
                        <span class="badge badge-warning">Unverified</span>
                    {% endif %}
                </p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon bg-success">
                <i class="fas fa-desktop"></i>
            </div>
            <div class="stat-content">
                <h3>Active Sessions</h3>
                <p class="stat-value">{{ sessions|length }}</p>
                <p class="stat-description">Devices currently logged in</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon bg-info">
                <i class="fas fa-link"></i>
            </div>
            <div class="stat-content">
                <h3>Connected Accounts</h3>
                <p class="stat-value">{{ oauth_connections|length }}</p>
                <p class="stat-description">OAuth providers linked</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon bg-warning">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-content">
                <h3>Last Sign In</h3>
                <p class="stat-value">
                    {% if user.last_sign_in_at %}
                        {{ user.last_sign_in_at|datetime }}
                    {% else %}
                        Just now
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="dashboard-grid">
        <!-- Active Sessions Panel -->
        <div class="dashboard-panel">
            <div class="panel-header">
                <h2><i class="fas fa-laptop"></i> Active Sessions</h2>
                <span class="badge">{{ sessions|length }}</span>
            </div>
            <div class="panel-content">
                {% if sessions %}
                    <div class="sessions-list">
                        {% for session in sessions %}
                        <div class="session-item">
                            <div class="session-icon">
                                {% if session.device_info and session.device_info.platform == 'mobile' %}
                                    <i class="fas fa-mobile-alt"></i>
                                {% elif session.device_info and session.device_info.platform == 'tablet' %}
                                    <i class="fas fa-tablet-alt"></i>
                                {% else %}
                                    <i class="fas fa-laptop"></i>
                                {% endif %}
                            </div>
                            <div class="session-details">
                                <div class="session-name">
                                    {% if session.device_info %}
                                        {{ session.device_info.platform|title }} Device
                                    {% else %}
                                        Unknown Device
                                    {% endif %}
                                    {% if session.remember_me %}
                                        <span class="badge badge-sm badge-info">Remember Me</span>
                                    {% endif %}
                                </div>
                                <div class="session-meta">
                                    <span><i class="fas fa-map-marker-alt"></i> {{ session.ip_address }}</span>
                                    <span><i class="fas fa-clock"></i> Last active: {{ session.last_activity_at|datetime }}</span>
                                </div>
                            </div>
                            <button onclick="revokeSession('{{ session.id }}')" class="btn btn-sm btn-danger">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>No active sessions</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- OAuth Connections Panel -->
        <div class="dashboard-panel">
            <div class="panel-header">
                <h2><i class="fas fa-plug"></i> Connected Accounts</h2>
                <span class="badge">{{ oauth_connections|length }}</span>
            </div>
            <div class="panel-content">
                <div class="oauth-list">
                    <!-- Google -->
                    <div class="oauth-item">
                        <div class="oauth-provider">
                            <i class="fab fa-google"></i>
                            <span>Google</span>
                        </div>
                        {% set google_connected = oauth_connections|selectattr('provider', 'equalto', 'google')|list|length > 0 %}
                        {% if google_connected %}
                            <span class="badge badge-success">Connected</span>
                        {% else %}
                            <a href="{{ url_for('oauth_login', provider='google') }}" class="btn btn-sm btn-outline">
                                Connect
                            </a>
                        {% endif %}
                    </div>

                    <!-- GitHub -->
                    <div class="oauth-item">
                        <div class="oauth-provider">
                            <i class="fab fa-github"></i>
                            <span>GitHub</span>
                        </div>
                        {% set github_connected = oauth_connections|selectattr('provider', 'equalto', 'github')|list|length > 0 %}
                        {% if github_connected %}
                            <span class="badge badge-success">Connected</span>
                        {% else %}
                            <a href="{{ url_for('oauth_login', provider='github') }}" class="btn btn-sm btn-outline">
                                Connect
                            </a>
                        {% endif %}
                    </div>
                </div>

                {% if oauth_connections %}
                    <div class="oauth-details">
                        <h4>Connection Details</h4>
                        {% for conn in oauth_connections %}
                        <div class="oauth-detail-item">
                            <strong>{{ conn.provider|title }}</strong>
                            <span>Connected: {{ conn.created_at|datetime }}</span>
                            {% if conn.provider_email %}
                                <span>Email: {{ conn.provider_email }}</span>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Security Panel -->
        <div class="dashboard-panel">
            <div class="panel-header">
                <h2><i class="fas fa-shield-alt"></i> Security</h2>
            </div>
            <div class="panel-content">
                <div class="security-items">
                    <div class="security-item">
                        <div class="security-icon">
                            <i class="fas fa-key"></i>
                        </div>
                        <div class="security-details">
                            <h4>Password</h4>
                            <p>Last changed: Never</p>
                        </div>
                        <button class="btn btn-sm btn-outline">Change</button>
                    </div>

                    <div class="security-item">
                        <div class="security-icon">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="security-details">
                            <h4>Email</h4>
                            <p>{{ user.email }}</p>
                        </div>
                        {% if not user.email_verified %}
                            <button class="btn btn-sm btn-primary">Verify</button>
                        {% endif %}
                    </div>

                    <div class="security-item">
                        <div class="security-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="security-details">
                            <h4>Two-Factor Auth</h4>
                            <p>Not enabled</p>
                        </div>
                        <button class="btn btn-sm btn-outline">Enable</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions Panel -->
        <div class="dashboard-panel">
            <div class="panel-header">
                <h2><i class="fas fa-bolt"></i> Quick Actions</h2>
            </div>
            <div class="panel-content">
                <div class="quick-actions">
                    <a href="{{ url_for('profile') }}" class="action-button">
                        <i class="fas fa-user-edit"></i>
                        <span>Edit Profile</span>
                    </a>
                    <a href="{{ url_for('magic_link_page') }}" class="action-button">
                        <i class="fas fa-magic"></i>
                        <span>Get Magic Link</span>
                    </a>
                    <a href="#" class="action-button" onclick="downloadData(); return false;">
                        <i class="fas fa-download"></i>
                        <span>Download Data</span>
                    </a>
                    <a href="#" class="action-button text-danger" onclick="deleteAccount(); return false;">
                        <i class="fas fa-trash-alt"></i>
                        <span>Delete Account</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Logout from all devices
async function logoutAll() {
    if (!confirm('Are you sure you want to logout from all devices?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/auth/logout-all', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSuccess('Logged out from all devices');
            setTimeout(() => {
                window.location.href = '{{ url_for("login") }}';
            }, 1500);
        } else {
            showError(data.error || 'Failed to logout');
        }
    } catch (error) {
        console.error('Logout error:', error);
        showError('An error occurred');
    }
}

// Revoke specific session
async function revokeSession(sessionId) {
    if (!confirm('Revoke this session?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/user/sessions/${sessionId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSuccess('Session revoked');
            location.reload();
        } else {
            showError(data.error || 'Failed to revoke session');
        }
    } catch (error) {
        console.error('Revoke error:', error);
        showError('An error occurred');
    }
}

// Download user data
function downloadData() {
    showInfo('Preparing your data...');
    // Implementation would go here
}

// Delete account
function deleteAccount() {
    if (!confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
        return;
    }
    
    const password = prompt('Enter your password to confirm:');
    if (!password) {
        return;
    }
    
    showWarning('Account deletion is not implemented in this demo');
}
</script>
{% endblock %}
